# Example configuration for using F-Secure See


This folder is about to show example configuration to run sample with https://github.com/F-Secure/see

**Prequisities**

Setting up the F-Secure See : https://see.readthedocs.io/en/latest/tutorial_installation.html

This configuration has been tested with Ubuntu 16.04  (Should work on Debian Stretch). Some tweaking required on libraries.

There are some issues with libguestfs-tools at least with latest Kali Linux and Ubuntu 18.04, so diskanalysis plugin is not working on those distributions.

In Kali Linux it works, but performance is very low.

VMWare player has been used to run Ubuntu. Intel VT-x etc. should be enabled for nested virtual machines.

Windows 7 has been used as target operating system. Available here: https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/
IE11 VirtualBox version has been used, estimated size is about 5 GB.

Steps here must be reproduced: https://see.readthedocs.io/en/latest/tutorial_setup.html
Windows7.xml should be moved to conf folder, replacing older one.
contex.json and hook_conf.json 

Sometimes mouse and keyboard is not working inside Windows quest, this can be fixed with:
```shell
sudo virt-xml $vmname --add-device --input tablet
```
vmname is correctly imported qemu machine.

Example command to run sandbox, once correctly configured:
```shell
python3 sandbox.py conf/context.json malware/WannaCry/ed01ebfbc9eb5bbea545af4d01bf5f1071661840480439c6e5babe8e080e41aa.exe --hooks conf/hook_conf.json --command "start {sample}"
```

##

# Dependencies and potential problems on plugins

**For disk analyzer plugin, these libraries are required**

```shell
pip3 install vminspect
apt install python3-hivex
apt install libguestfs-tools #Required for python3-guestfs
```

There might be  following problem: 'Failed to get shared "write" lock', when using DiskCheckPointHook,
this problem can be fixed by ignoring the risk of shared file, by adding:  "-U", into line 221 in the file disk.py
If error doest not appear, it shoud not be added.

# Useful commands

Convert vmdk file to qcow2

> qemu-img convert -f vmdk -O qcow2 image.vmdk image.qcow2

Create xml dump (vm configuration settings):

>virsh dumpxml GuestID > guest.xml

## Volatility
Get imageinfo with volatility:

>sudo python2 /home/compsec/Documents/Volatility/volatility/vol.py -f snapshots_capture_135927.bin imageinfo

# Other instructions

## Configuring network

To create isolated network for libvirt properly,
save following sample to /tmp/isolated.xml

```xml
<network>
  <name>isolated</name>
  <ip address='192.168.254.1' netmask='255.255.255.0'>
    <dhcp>
      <range start='192.168.254.2' end='192.168.254.254' />
    </dhcp>
  </ip>
</network>
```
Create the network:  

```virsh net-define /tmp/isolated.xml```

Add autostart:

```virsh net-autostart isolated```

Start the network: 

```virsh net-start isolated```

Add following part to guest virtual machine xml configuration:

```xml
<interface type='network'>
  <source network='isolated'/>
</interface>

```
## Adding local DNS entry
Sometimes there might be a scenario, when you want to redirect traffic from malware to not-real host, but to the one you are controlling..

This has appeared to be tricky on host, since libvirt uses it's own instance of dnsmasq.

One solution is to edit above network configuration, by adding:
```xml
<dns>
  <host ip='192.168.100.1'>
    <hostname>example.com</hostname>
    <hostname>www.example.com</hostname>
  </host>
</dns>

```
Theorically example.com is now directing to host machine, inside from guest machine.

Another solution is to add hostname to /etc/hosts and configure libvirt-dnsmasq to use it.

Of course DNS entry could be just added inside guest virtual machine, but then it is not so 'pure' anymore.